@using PerformanceReviewWeb.Models
@model List<NotificationResponse>
@{
    ViewData["Title"] = "Уведомления";
    var user = ViewBag.User as UserResponse;
    var unreadOnly = ViewBag.UnreadOnly as bool? ?? false;
}

<div class="container-fluid">
    <!-- Заголовок и кнопки управления -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
        <h1 class="mb-0 h4 h3-lg">
            <i class="fas fa-bell me-2"></i>Уведомления
        </h1>
        <div class="d-flex flex-column flex-md-row gap-2 w-100 w-lg-auto">
            <button id="markAllRead" class="btn btn-outline-success order-2 order-md-1">
                <i class="fas fa-check-double me-1 d-none d-md-inline"></i>
                <span class="d-none d-md-inline">Отметить все как прочитанные</span>
                <span class="d-inline d-md-none d-lg-inline">Все прочитано</span>
                <span class="d-none d-lg-inline d-xl-none">Все прочит.</span>
            </button>
            <div class="btn-group order-1 order-md-2 flex-nowrap">
                <a href="/notifications" class="btn @(!unreadOnly ? "btn-primary" : "btn-outline-primary")">
                    <span class="d-none d-xl-inline">Все</span>
                    <span class="d-inline d-xl-none">Все</span>
                </a>
                <a href="/notifications?unread_only=true" class="btn @(unreadOnly ? "btn-primary" : "btn-outline-primary")">
                    <span class="d-none d-xl-inline">Непрочитанные</span>
                    <span class="d-inline d-xl-none">Новые</span>
                </a>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            @if (Model != null && Model.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var notification in Model)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-start p-3 @(!notification.IsRead ? "bg-light border-start border-primary border-3" : "")">
                            <div class="flex-grow-1 me-3">
                                <div class="fw-bold @(!notification.IsRead ? "text-dark" : "text-body") mb-1 small-lg">
                                    @notification.Title
                                </div>
                                <div class="@(!notification.IsRead ? "text-dark" : "text-muted") mb-2 small-lg">
                                    @notification.Message
                                </div>
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <small class="text-muted small-lg">
                                        <i class="fas fa-clock me-1"></i>@notification.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                                    </small>
                                    @if (!string.IsNullOrEmpty(notification.RelatedEntityType))
                                    {
                                        <small class="badge bg-info small-lg">
                                            <span class="d-none d-lg-inline">@notification.RelatedEntityType</span>
                                            <span class="d-inline d-lg-none">@GetShortEntityType(notification.RelatedEntityType)</span>
                                        </small>
                                    }
                                    <small class="badge bg-secondary small-lg">
                                        <span class="d-none d-lg-inline">@notification.NotificationType</span>
                                        <span class="d-inline d-lg-none">@GetShortNotificationType(notification.NotificationType)</span>
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2 flex-shrink-0">
                                @if (!notification.IsRead)
                                {
                                    <button class="btn btn-sm btn-outline-success mark-as-read" 
                                            data-id="@notification.Id"
                                            title="Отметить как прочитанное">
                                        <i class="fas fa-check me-1 d-none d-xl-inline"></i>
                                        <span class="d-none d-xl-inline">Прочитано</span>
                                        <span class="d-inline d-xl-none">Прочит.</span>
                                    </button>
                                }
                                else
                                {
                                    <span class="badge bg-success small-lg">
                                        <i class="fas fa-check me-1 d-none d-xl-inline"></i>
                                        <span class="d-none d-xl-inline">Прочитано</span>
                                        <span class="d-inline d-xl-none">Прочит.</span>
                                    </span>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <h5 class="h6 h5-lg">Уведомлений нет</h5>
                    <p class="text-muted small-lg">@(unreadOnly ? "Нет непрочитанных уведомлений" : "У вас пока нет уведомлений")</p>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    private string GetShortEntityType(string entityType)
    {
        return entityType switch
        {
            "Goal" => "Цель",
            "Review" => "Оценка",
            "User" => "Польз.",
            _ => entityType.Length > 8 ? entityType.Substring(0, 8) + "..." : entityType
        };
    }

    private string GetShortNotificationType(string notificationType)
    {
        return notificationType switch
        {
            "GoalReminder" => "Напом.",
            "ReviewAssigned" => "Оценка",
            "System" => "Система",
            "Info" => "Инфо",
            "Warning" => "Вним.",
            _ => notificationType.Length > 6 ? notificationType.Substring(0, 6) + "..." : notificationType
        };
    }
}

@section Styles {
    <style>
        /* Адаптивные размеры текста для средних разрешений */
        .small-lg {
            font-size: 0.875rem;
        }
        
        .h3-lg {
            font-size: 1.5rem;
        }
        
        .h5-lg {
            font-size: 1.1rem;
        }
        
        /* Улучшения для средних разрешений (768px - 1200px) */
        @@media (min-width: 768px) and (max-width: 1200px) {
            .container-fluid {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .list-group-item {
                padding: 0.75rem !important;
            }
            
            .btn-group .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
            }
            
            #markAllRead {
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .badge {
                font-size: 0.75rem;
                padding: 0.35em 0.65em;
            }
            
            .mark-as-read {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }
        
        /* Улучшения для очень узких экранов */
        @@media (max-width: 576px) {
            .list-group-item {
                flex-direction: column;
                align-items: stretch !important;
                gap: 1rem;
            }
            
            .list-group-item > div:last-child {
                align-self: flex-end;
            }
        }
        
        /* Плавные переходы */
        .list-group-item {
            transition: all 0.2s ease-in-out;
        }
        
        .btn, .badge {
            transition: all 0.2s ease-in-out;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Отметить как прочитанное
            document.querySelectorAll('.mark-as-read').forEach(button => {
                button.addEventListener('click', async function() {
                    const notificationId = this.getAttribute('data-id');
                    const button = this;
                    
                    try {
                        // Показываем индикатор загрузки
                        button.disabled = true;
                        const originalContent = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i><span class="d-none d-xl-inline">Обработка...</span><span class="d-inline d-xl-none">Загрузка</span>';
                        
                        const response = await fetch(`/notifications/mark-read/${notificationId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            // Обновляем внешний вид уведомления
                            const notificationItem = button.closest('.list-group-item');
                            notificationItem.classList.remove('bg-light', 'border-start', 'border-primary', 'border-3');
                            
                            // Заменяем кнопку на бейдж "Прочитано"
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success small-lg';
                            badge.innerHTML = '<i class="fas fa-check me-1 d-none d-xl-inline"></i><span class="d-none d-xl-inline">Прочитано</span><span class="d-inline d-xl-none">Прочит.</span>';
                            button.parentNode.replaceChild(badge, button);
                            
                            // Обновляем счетчики
                            loadNotificationCount();
                            showToast('Успех', 'Уведомление отмечено как прочитанное', 'success');
                        } else {
                            throw new Error(result.message || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                        // Восстанавливаем кнопку
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        showToast('Ошибка', 'Не удалось отметить уведомление как прочитанное', 'error');
                    }
                });
            });

            // Отметить все как прочитанные
            document.getElementById('markAllRead').addEventListener('click', async function() {
                const button = this;
                
                try {
                    // Показываем индикатор загрузки
                    button.disabled = true;
                    const originalContent = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i><span class="d-none d-md-inline">Обработка...</span><span class="d-inline d-md-none">Загрузка</span>';
                    
                    const response = await fetch('/notifications/mark-all-read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Обновляем все уведомления на странице
                        document.querySelectorAll('.mark-as-read').forEach(btn => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success small-lg';
                            badge.innerHTML = '<i class="fas fa-check me-1 d-none d-xl-inline"></i><span class="d-none d-xl-inline">Прочитано</span><span class="d-inline d-xl-none">Прочит.</span>';
                            btn.parentNode.replaceChild(badge, btn);
                        });
                        
                        // Убираем выделение непрочитанных
                        document.querySelectorAll('.list-group-item').forEach(item => {
                            item.classList.remove('bg-light', 'border-start', 'border-primary', 'border-3');
                        });
                        
                        // Обновляем счетчики
                        loadNotificationCount();
                        showToast('Успех', 'Все уведомления отмечены как прочитанные', 'success');
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    showToast('Ошибка', 'Не удалось отметить все уведомления как прочитанные', 'error');
                } finally {
                    // Восстанавливаем кнопку
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            });
        });

        function showToast(title, message, type) {
            // Используем существующий toast контейнер или создаем новый
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'success' : 'danger';
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-bg-${bgClass} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        <strong>${title}</strong> - ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
        
        function loadNotificationCount() {
            fetch('/notifications/unread-count')
                .then(response => response.json())
                .then(data => {
                    updateNotificationBadge(data.count || 0);
                })
                .catch(error => console.error('Error loading notification count:', error));
        }

        function updateNotificationBadge(count) {
            // Обновляем бейджи в layout
            const badges = document.querySelectorAll('#notificationCount, #sidebarNotificationCount, .notification-badge');
            badges.forEach(badge => {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.classList.remove('d-none');
                } else {
                    badge.classList.add('d-none');
                }
            });
        }

        // Вызываем при загрузке страницы
        loadNotificationCount();
    </script>
}