@using PerformanceReviewWeb.Models
@model EmployeeSummaryResponse
@{
    ViewData["Title"] = "Аналитика производительности";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 h4-md h2-lg">
            <i class="fas fa-chart-bar me-2"></i>Аналитика производительности
        </h1>
    </div>

    <!-- Общая статистика -->
    <div class="row mb-4 g-3">
        <div class="col-sm-6 col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="h5 h4-md mb-1">@Model.TotalGoals</h4>
                            <p class="mb-0 small">Всего целей</p>
                        </div>
                        <div>
                            <i class="fas fa-bullseye fa-lg fa-2x-md opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="h5 h4-md mb-1">@Model.CompletedGoals</h4>
                            <p class="mb-0 small">Завершено целей</p>
                        </div>
                        <div>
                            <i class="fas fa-check-circle fa-lg fa-2x-md opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="h5 h4-md mb-1">@Model.AverageScore.ToString("F1")</h4>
                            <p class="mb-0 small">Средний балл</p>
                        </div>
                        <div>
                            <i class="fas fa-star fa-lg fa-2x-md opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="h5 h4-md mb-1">@Model.OverallRating</h4>
                            <p class="mb-0 small">Общий рейтинг</p>
                        </div>
                        <div>
                            <i class="fas fa-chart-line fa-lg fa-2x-md opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная аналитика по целям -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0 h6 h5-md">
                <i class="fas fa-list-alt me-2"></i>Детальная аналитика по целям
            </h5>
        </div>
        <div class="card-body">
            @if (Model.GoalsAnalytics.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="d-none d-md-table-cell">Цель</th>
                                <th class="d-table-cell d-md-none">Цель</th>
                                <th class="text-nowrap">
                                    <span class="d-none d-md-inline">Самооценка</span>
                                    <span class="d-inline d-md-none">С-оценка</span>
                                </th>
                                <th class="text-nowrap">
                                    <span class="d-none d-md-inline">Руководитель</span>
                                    <span class="d-inline d-md-none">Руков.</span>
                                </th>
                                <th class="text-nowrap">
                                    <span class="d-none d-md-inline">Коллеги</span>
                                    <span class="d-inline d-md-none">Колл.</span>
                                </th>
                                <th class="text-nowrap">
                                    <span class="d-none d-md-inline">Общий балл</span>
                                    <span class="d-inline d-md-none">Общий</span>
                                </th>
                                <th class="text-nowrap">Рейтинг</th>
                                <th class="text-nowrap">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var analytics in Model.GoalsAnalytics)
                            {
                                <tr>
                                    <td>
                                        <div>
                                            <strong class="small d-md-none">@GetShortTitle(analytics.GoalTitle)</strong>
                                            <strong class="d-none d-md-inline">@analytics.GoalTitle</strong>
                                            <br>
                                            <small class="text-muted">
                                                <span class="d-none d-md-inline">@analytics.ReviewCount оценок, @analytics.RespondentCount респондентов</span>
                                                <span class="d-inline d-md-none">@analytics.ReviewCount оц., @analytics.RespondentCount респ.</span>
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@analytics.Scores.SelfScore.ToString("F1")</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@analytics.Scores.ManagerScore.ToString("F1")</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@analytics.Scores.RespondentScore.ToString("F1")</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">@analytics.Scores.TotalScore.ToString("F1")</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(analytics.FinalRating))
                                        {
                                            <span class="badge rating-@analytics.FinalRating.ToLower()">
                                                <span class="d-none d-md-inline">@GetRatingText(analytics.FinalRating)</span>
                                                <span class="d-inline d-md-none">@GetShortRatingText(analytics.FinalRating)</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">
                                                <span class="d-none d-md-inline">Не установлен</span>
                                                <span class="d-inline d-md-none">Н/у</span>
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <a href="/analytics/goal/@analytics.GoalId" class="btn btn-sm btn-outline-primary" title="Детальная аналитика">
                                            <i class="fas fa-chart-line d-none d-md-inline me-1"></i>
                                            <i class="fas fa-chart-line d-inline d-md-none"></i>
                                            <span class="d-none d-md-inline">Детали</span>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="h6 h5-md">Нет данных для анализа</h5>
                    <p class="text-muted small">Создайте цели и получите оценки для просмотра аналитики</p>
                    <a href="/goals/create" class="btn btn-primary btn-sm">Создать первую цель</a>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    private string GetRatingText(string rating)
    {
        return rating?.ToLower() switch
        {
            "excellent" => "Отлично",
            "good" => "Хорошо",
            "satisfactory" => "Удовлетворительно",
            "poor" => "Плохо",
            "unsatisfactory" => "Неудовлетворительно",
            _ => rating ?? "Не установлен"
        };
    }

    private string GetShortRatingText(string rating)
    {
        return rating?.ToLower() switch
        {
            "excellent" => "Отл.",
            "good" => "Хор.",
            "satisfactory" => "Удов.",
            "poor" => "Плохо",
            "unsatisfactory" => "Неуд.",
            _ => "Н/у"
        };
    }

    private string GetShortTitle(string title)
    {
        if (string.IsNullOrEmpty(title)) return "";
        return title.Length > 20 ? title.Substring(0, 20) + "..." : title;
    }
}

@section Styles {
    <style>
        .rating-excellent { background-color: #28a745 !important; }
        .rating-good { background-color: #20c997 !important; }
        .rating-satisfactory { background-color: #ffc107 !important; color: #000 !important; }
        .rating-poor { background-color: #fd7e14 !important; }
        .rating-unsatisfactory { background-color: #dc3545 !important; }
        
        /* Адаптивные размеры иконок */
        .fa-2x-md {
            font-size: 1.5em;
        }
        
        /* Адаптивные размеры заголовков */
        .h4-md {
            font-size: 1.5rem;
        }
        
        .h5-md {
            font-size: 1.1rem;
        }
        
        .h2-lg {
            font-size: 1.8rem;
        }
        
        /* Улучшения для таблицы */
        .table td, .table th {
            padding: 0.75rem 0.5rem;
        }
        
        /* Улучшения для карточек статистики */
        .card-body.p-3 {
            padding: 1rem !important;
        }
        
        /* Медиа-запросы для тонкой настройки */
        @@media (max-width: 768px) {
            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        
        @@media (min-width: 768px) and (max-width: 1200px) {
            .table td, .table th {
                padding: 0.5rem 0.3rem;
                font-size: 0.875rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.775rem;
            }
        }
    </style>
}